<!-- ======================================================================= -->
<!-- APS                                                                     -->
<!--                                                                         -->
<!-- (C) Copyright 2015-2016 Vladimir Grechka                                -->
<!-- ======================================================================= -->

<project name="aps">
    <property environment="env"/>

    <include file="${env.INTO_KOMMON_HOME}/build-into-kommon-inc.xml" as="inc"/>

    <path id="cp">
        <path refid="into-kommon-jvm-classpath"/>
        <pathelement location="${env.APS_HOME}/back/out"/>
        <fileset dir="${env.APS_HOME}/back/lib" includes="*.jar"/>
        <fileset dir="${env.APS_HOME}/back/lib-gradle" includes="*.jar"/>
    </path>

    <target name="before-compilation">
    </target>

    <target name="after-compilation">
        <ant antfile="${env.INTO_KOMMON_HOME}/build-into-kommon.xml" target="after-compilation"/>

        <java classname="aps.LintShit" fork="true" failonerror="true">
            <classpath refid="cp"/>
        </java>

        <antcall target="inc.enhance-js">
            <param name="inFile" value="${env.APS_HOME}/front/out/front.js"/>
        </antcall>

        <copy file="${env.APS_HOME}/front/out/front-enhanced.js" todir="${env.APS_HOME}/aps/built/ua-writer" overwrite="true"/>
        <copy file="${env.APS_HOME}/front/out/front.js.map" todir="${env.APS_HOME}/aps/built/ua-writer" overwrite="true"/>
        <copy file="${env.INTO_KOMMON_HOME}/js/out/into-kommon-js-enhanced.js" todir="${env.APS_HOME}/aps/built/ua-writer" overwrite="true"/>
        <copy file="${env.INTO_KOMMON_HOME}/js/out/into-kommon-js.js.map" todir="${env.APS_HOME}/aps/built/ua-writer" overwrite="true"/>

        <pathconvert targetos="windows" property="cpstring" refid="cp"/>
        <echo file="_run.cmd">
            @java -cp ${cpstring} %*
        </echo>

        <touch file="${env.APS_HOME}/_restart-flag"/>
    </target>

    <target name="make-static-sites">
        <exec executable="node" dir="${env.APS_HOME}/front">
            <arg value="run.js"/>
            <arg value="MakeStaticSites"/>
            <arg value="--mode=debug"/>
        </exec>
    </target>
</project>




